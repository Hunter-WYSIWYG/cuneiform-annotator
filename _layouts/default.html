<!DOCTYPE html>
<html>

  {% include head.html %}

  <body>

    {% include header.html %}
	<link type="text/css" rel="stylesheet" href="stylesheet/3dhop.css"/>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/css/bootstrap.min.css" integrity="sha384-AysaV+vQoT3kOAXZkl02PThvDr8HYKPZhNT5h/CXfBThSRXQ6jW5DO2ekP5ViFdi" crossorigin="anonymous">
<!--SPIDERGL-->
<script type="text/javascript" src="js/spidergl.js"></script>
<!--JQUERY-->
<script type="text/javascript" src="js/jquery.js"></script>
<!--PRESENTER-->
<script type="text/javascript" src="js/presenter.js"></script>
<script type="text/javascript" src="js/presenter_added.js"></script>
<script type="text/javascript" src="js/presenter_extended.js"></script>
<!--3D MODELS LOADING AND RENDERING-->
<script type="text/javascript" src="js/nexus.js"></script>
<script type="text/javascript" src="js/ply.js"></script>
<!--TRACKBALLS-->
<script type="text/javascript" src="js/trackball_turntable.js"></script>
<script type="text/javascript" src="js/trackball_turntable_pan.js"></script>
<script type="text/javascript" src="js/trackball_pantilt.js"></script>
<script type="text/javascript" src="js/trackball_sphere.js"></script>
<!--UTILITY-->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/js/bootstrap.min.js" integrity="sha384-BLiI7JTZm+JWlgKa0M0kGRpJbF2J8q+qreVrKBC47e3K6BW78kGLrCkeRX6I9RoK" crossorigin="anonymous"></script>
<script type="text/javascript" src="js/init.js"></script>
<script type="text/javascript" src="js/init_added.js"></script>
<script src="js/saveTextAsFile.js"></script>
<script src="js/gitbeaker.js"></script>
<script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
<div class="container-fluid">
    <div class="row">
      <div class="col-md-12" role="main">
<select id="images" onchange="reinit()"></select>
<button id="saveAnnotations" onclick="saveTextAsFile(JSON.stringify(curanno),'json','anno')">Save Annotations</button>
<button id="saveInGit" onclick="commitData()">Save Annotation in Gitlab</button>
<script>
  const gitlabtoken="bPaesdD1s-gcJ5qzaaDv"
  const { Gitlab } = gitbeaker;
  const api = new Gitlab({
  token: gitlabtoken, //'9zyFECzKmuhkMo81HKPw',
  host: 'https://gitlab.rlp.net',
  version: 4
});
async function startit() { 
  // Your async task will execute with await
  //var users= await api.Projects.show("16599");
  var users= await api.RepositoryFiles.show(16599, ".gitlab-ci.yml","master");
  console.log(users)
}
startit();
</script>
<script>
async function commitData(){

try{
  var users= await api.RepositoryFiles.create(16599, "result/"+$('#images option:selected').text()+".json","master",JSON.stringify(curanno),"Committed "+$('#images option:selected').text()+".json");
}catch (e) {
  var users= await api.RepositoryFiles.edit(16599, "result/"+$('#images option:selected').text()+".json","master",JSON.stringify(curanno),"Committed "+$('#images option:selected').text()+".json");
}
console.log(users)
/*
  headers:{
    "Authorization": "Bearer bPaesdD1s-gcJ5qzaaDv",
    "PRIVATE-TOKEN":"bPaesdD1s-gcJ5qzaaDv",
    "accept":"",
    "content-type": "application/json; charset=utf-8"
  }*/
}

function success(){
  console.log("succeeded!!!!!")
}

async function getAnnotation(path){
  var users= await api.RepositoryFiles.show(16599, "result/"+$('#images option:selected').text()+".json","master",JSON.stringify(curanno)
,"Committed "+$('#images option:selected').text()+".json");
  console.log(users)
  console.log(atob(users["content"]))
  return JSON.parse(atob(users["content"]))
}

  var options=""
  for(url of urls){
    options+="<option value=\""+url["value"]+"\">"+url["label"]+"</option>"
  }
  document.getElementById("images").innerHTML=options
  var index=0;
  var curanno={}
  var viewer;
  var anno;
  window.onload = function() {
    viewer = OpenSeadragon({
      id: "openseadragon",
      prefixUrl: "openseadragon/images/",
      tileSources: {
        type: "image",
        url: "https://heidicon.ub.uni-heidelberg.de/iiif/2/1127792:592134/full/full/0/default.jpg"
      }
    });

    // Initialize the Annotorious plugin
    anno = OpenSeadragon.Annotorious(viewer);

    // Load annotations in W3C WebAnnotation format
    //anno.loadAnnotations('annotations.w3c.json');
    try{
      anno.loadAnnotations("https://gitlab.rlp.net/projects/16599/files/result%2F"+encodeURIComponent($('#images option:selected').text()+".json")+"/raw?ref=master&access_token="+gitlabtoken)
    }catch(e){
      console.log(e)
    }
    // Attach handlers to listen to events
    anno.on('createAnnotation', function(a) {
      console.log(a)
      console.log(JSON.stringify(a))
      curanno[a["id"]]=a
    });
    anno.on('deleteAnnotation', function(a) {
      delete curanno[a["id"]]
    });
    anno.on('updateAnnotation', function(a) {
      curanno[a["id"]]=a
    });
  }
  function reinit(){
    viewer.open({
        type: "image",
        url: $('#images').val()
      });

    anno.destroy()
        // Initialize the Annotorious plugin
    var anno = OpenSeadragon.Annotorious(viewer);

    // Load annotations in W3C WebAnnotation format
    //anno.loadAnnotations('annotations.w3c.json');
        try{
      anno.loadAnnotations("https://gitlab.rlp.net/projects/16599/files/result%2F"+encodeURIComponent($('#images option:selected').text()+".json")+"/raw?ref=master&access_token="+gitlabtoken)
    }catch(e){
      console.log(e)
    }
    curanno={}
    // Attach handlers to listen to events
    anno.on('createAnnotation', function(a) {
      console.log(a)
      console.log(JSON.stringify(a))
      curanno[a["id"]]=a
    });
    anno.on('deleteAnnotation', function(a) {
      delete curanno[a["id"]]
    });
    anno.on('updateAnnotation', function(a) {
      curanno[a["id"]]=a
    });
  }
</script>

<div id="openseadragon" style="width: 640px; height: 480px;"></div>
      </div>
    </div>
	</div>    <div class="row">
</div>
<div class="col-md-12">
<div id="3dhop" class="tdhop" onmousedown="if (event.preventDefault) event.preventDefault()"><div id="tdhlg"></div>
 <div id="toolbar">
  <img id="home"        title="Home"                   src="skins/dark/home.png"/><br/>
<!--ZOOM-->
  <img id="zoomin"      title="Zoom In"                src="skins/dark/zoomin.png"/><br/>
  <img id="zoomout"     title="Zoom Out"               src="skins/dark/zoomout.png"/><br/>
<!--ZOOM-->
<!--LIGHTING-->
  <img id="lighting_off" title="Enable Lighting"       src="skins/dark/lighting_off.png" style="position:absolute; visibility:hidden;"/>
  <img id="lighting"     title="Disable Lighting"      src="skins/dark/lighting.png"/><br/>
<!--LIGHTING-->
<!--LIGHT-->
  <img id="light_on"    title="Disable Light Control"  src="skins/dark/lightcontrol_on.png" style="position:absolute; visibility:hidden;"/>
  <img id="light"       title="Enable Light Control"   src="skins/dark/lightcontrol.png"/><br/>
<!--LIGHT-->
<!--MEASURE-->
  <img id="measure_on"  title="Disable Measure Tool"   src="skins/dark/measure_on.png" style="position:absolute; visibility:hidden;"/>
  <img id="measure"     title="Enable Measure Tool"    src="skins/dark/measure.png"/><br/>
<!--MEASURE-->
<!--POINT PICKING-->
  <img id="pick_on"     title="Disable PickPoint Mode" src="skins/dark/pick_on.png" style="position:absolute; visibility:hidden;"/>
  <img id="pick"        title="Enable PickPoint Mode"  src="skins/dark/pick.png"/><br/>
<!--POINT PICKING-->
<!--SECTIONS-->
  <img id="sections_on" title="Disable Plane Sections" src="skins/dark/sections_on.png" style="position:absolute; visibility:hidden;"/>
  <img id="sections"    title="Enable Plane Sections"  src="skins/dark/sections.png"/><br/>
<!--SECTIONS-->
<!--COLOR-->
  <img id="color_on"    title="Disable Solid Color"    src="skins/dark/color_on.png" style="position:absolute; visibility:hidden;"/>
  <img id="color"       title="Enable Solid Color"     src="skins/dark/color.png"/><br/>
<!--COLOR-->
<!--CAMERA-->
  <img id="perspective"  title="Perspective Camera"    src="skins/dark/perspective.png" style="position:absolute; visibility:hidden;"/>
  <img id="orthographic" title="Orthographic Camera"   src="skins/dark/orthographic.png"/><br/>
<!--CAMERA-->
<!--SCREENSHOT-->
  <img id="screenshot" title="Save Screenshot"   src="skins/dark/screenshot.png"/><br/>
<!--SCREENSHOT-->
<!--FULLSCREEN-->
  <img id="full_on"     title="Exit Full Screen"       src="skins/dark/full_on.png" style="position:absolute; visibility:hidden;"/>
  <img id="full"        title="Full Screen"            src="skins/dark/full.png"/>
<!--FULLSCREEN-->
 </div>
             <div id="toolbar2">
                <img id="btn-edit-object" title="Edit Object Information" src="skins/dark/objectedit.png" /><br />
                <img id="select_on" title="Disable Selection Tool" src="skins/dark/polygon_selection_on.png" style="position:absolute; visibility:hidden;" />
                <img id="select" title="Enable Polygon Selection" src="skins/dark/polygon_selection.png" /><br />
                <img id="btn-test-polygoneditor" title="Test Polygon Editor" src="skins/dark/polygon_editor.png" /><br />
                <img id="btn-open-features-modal" title="Edit Features" src="skins/dark/features.png" /><br />
                <img id="btn-open-featuregroup-modal" title="Edit Features Groups" src="skins/dark/featuregroup.png" /><br />
                <img id="btn-open-interpretation-modal" title="Edit Interpretations" src="skins/dark/interpretation.png" /><br />
            </div>


<!--MEASURE-->
 <div id="measure-box" class="output-box">Measured length<hr/><span id="measure-output" class="output-text" onmousedown="event.stopPropagation()">0.0</span></div>
<!--MEASURE-->

<!--POINT PICKING-->
 <div id="pickpoint-box" class="output-box">XYZ picked point<hr/><span id="pickpoint-output" class="output-text" onmousedown="event.stopPropagation()">[ 0 , 0 , 0 ]</span></div>
<!--POINT PICKING-->

<!--SECTIONS-->
 <div id="sections-box" class="output-box">
  <table class="output-table" onmousedown="event.stopPropagation()">
	<tr><td>Plane</td><td>Position</td><td>Flip</td></tr>
	<tr>
		<td><img   id="xplane_on"    title="Disable X Axis Section" src="skins/icons/sectionX_on.png" onclick="sectionxSwitch()" style="position:absolute; visibility:hidden; border:1px inset;"/>
			<img   id="xplane"       title="Enable X Axis Section"  src="skins/icons/sectionX.png"  onclick="sectionxSwitch()"/><br/></td>
		<td><input id="xplaneSlider" class="output-input"  type="range"    title="Move X Axis Section Position"/></td>
		<td><input id="xplaneFlip"   class="output-input"  type="checkbox" title="Flip X Axis Section Direction"/></td></tr>
	<tr>
		<td><img   id="yplane_on"    title="Disable Y Axis Section" src="skins/icons/sectionY_on.png" onclick="sectionySwitch()" style="position:absolute; visibility:hidden; border:1px inset;"/>
			<img   id="yplane"       title="Enable Y Axis Section"  src="skins/icons/sectionY.png"  onclick="sectionySwitch()"/><br/></td>
		<td><input id="yplaneSlider" class="output-input"  type="range"    title="Move Y Axis Section Position"/></td>
		<td><input id="yplaneFlip"   class="output-input"  type="checkbox" title="Flip Y Axis Section Direction"/></td></tr>
	<tr>
		<td><img   id="zplane_on"    title="Disable Z Axis Section" src="skins/icons/sectionZ_on.png" onclick="sectionzSwitch()" style="position:absolute; visibility:hidden; border:1px inset;"/>
			<img   id="zplane"       title="Enable Z Axis Section"  src="skins/icons/sectionZ.png"  onclick="sectionzSwitch()"/><br/></td>
		<td><input id="zplaneSlider" class="output-input"  type="range"    title="Move Y Axis Section Position"/></td>
		<td><input id="zplaneFlip"   class="output-input"  type="checkbox" title="Flip Z Axis Section Direction"/></td></tr></table>
  <table class="output-table" onmousedown="event.stopPropagation()" style="text-align:right;">
	<tr>
	 <td>Show planes<input id="showPlane" class="output-input" type="checkbox" title="Show Section Planes" style="bottom:-3px;"/></td>
	 <td>Show edges<input  id="showBorder" class="output-input" type="checkbox" title="Show Section Edges" style="bottom:-3px;"/></td></tr></table>
 </div>
<!--SECTIONS-->

 <canvas id="draw-canvas" style="background-image: url(skins/backgrounds/light.jpg)"/>
</div>
<script type="text/javascript">
var presenter = null;

function setup3dhop() {
	presenter = new Presenter("draw-canvas");

	presenter.setScene({
		meshes: {
			"mesh_1" : { url: "models/gargo.nxz" }
		},
		modelInstances : {
			"model_1" : { 
				mesh  : "mesh_1",
				color : [0.8, 0.7, 0.75]
			}
		},
		trackball: {
			type : TurntablePanTrackball,
			trackOptions : {
				startPhi: 35.0,
				startTheta: 15.0,
				startDistance: 2.5,
				minMaxPhi: [-180, 180],
				minMaxTheta: [-30.0, 70.0],
				minMaxDist: [0.5, 3.0]
			}
		}
	});

//--MEASURE--
	presenter._onEndMeasurement = onEndMeasure;
//--MEASURE--

//--POINT PICKING--
	presenter._onEndPickingPoint = onEndPick;
//--POINT PICKING--

//--SECTIONS--
	sectiontoolInit();
//--SECTIONS--
}

function actionsToolbar(action) {
	if(action=='home') presenter.resetTrackball();
//--FULLSCREEN--
	else if(action=='full'  || action=='full_on') fullscreenSwitch();
//--FULLSCREEN--
//--ZOOM--
	else if(action=='zoomin') presenter.zoomIn();
	else if(action=='zoomout') presenter.zoomOut();
//--ZOOM--
//--LIGHTING--
	else if(action=='lighting' || action=='lighting_off') { presenter.enableSceneLighting(!presenter.isSceneLightingEnabled()); lightingSwitch(); }
//--LIGHTING--
//--LIGHT--
	else if(action=='light' || action=='light_on') { presenter.enableLightTrackball(!presenter.isLightTrackballEnabled()); lightSwitch(); }
//--LIGHT--
//--CAMERA--
	else if(action=='perspective' || action=='orthographic') { presenter.toggleCameraType(); cameraSwitch(); }
//--CAMERA--
//--COLOR--
	else if(action=='color' || action=='color_on') { presenter.toggleInstanceSolidColor(HOP_ALL, true); colorSwitch(); }
//--COLOR--
//--MEASURE--
	else if(action=='measure' || action=='measure_on') { presenter.enableMeasurementTool(!presenter.isMeasurementToolEnabled()); measureSwitch(); }
//--MEASURE--
//--POINT PICKING--
	else if(action=='pick' || action=='pick_on') { presenter.enablePickpointMode(!presenter.isPickpointModeEnabled()); pickpointSwitch(); }
//--POINT PICKING--
//--SCREENSHOT--
	else if(action=='screenshot') presenter.saveScreenshot();
//--SCREENSHOT--
//--SECTIONS--
	else if(action=='sections' || action=='sections_on') { sectiontoolReset(); sectiontoolSwitch(); }
//--SECTIONS--
}

//--MEASURE--
function onEndMeasure(measure) {
	// measure.toFixed(2) sets the number of decimals when displaying the measure
	// depending on the model measure units, use "mm","m","km" or whatever you have
	$('#measure-output').html(measure.toFixed(2) + "mm"); 
}
//--MEASURE--

//--PICKPOINT--
function onEndPick(point) {
	// .toFixed(2) sets the number of decimals when displaying the picked point	
	var x = point[0].toFixed(2);
	var y = point[1].toFixed(2);
	var z = point[2].toFixed(2);
    $('#pickpoint-output').html("[ "+x+" , "+y+" , "+z+" ]");
} 
//--PICKPOINT--	

function selectionSwitch(on) {
    if (on === undefined) on = presenter.isSelectionToolEnabel();

    if (on) {
        measureSwitch(false)
        //TODO: Deselect all other Tools

        $('#select').css("visibility", "hidden");
        $('#select_on').css("visibility", "visible");
        $('#draw-canvas').css("cursor", "copy");


    } else {
        $('#select').css("visibility", "visible");
        $('#select_on').css("visibility", "hidden");
        $('#draw-canvas').css("cursor", "default");
        test = presenter.isAnyMeasurementEnabled()
        if (!presenter.isAnyMeasurementEnabled()) $('#draw-canvas').css("cursor", "default");

    }

}

$(document).ready(function(){
	init3dhop();
	 var interval, id, ismousedown;
	 var button = 0;
$('#toolbar2 img')
        .mouseenter(function(e) {
            id = $(this).attr('id');
            if (!ismousedown) $(this).css("opacity", "0.8");
            else $(this).css("opacity", "1.0");
        })
        .mouseout(function(e) {
            clearInterval(interval);
            $(this).css("opacity", "0.5");
        })
        .mousedown(function(e) {
            id = $(this).attr('id');
            ismousedown = true;
            if (e.button == button) {
                actionsToolbar(id);
                if (id == "zoomin" || id == "zoomout") {
                    interval = setInterval(function() {
                        actionsToolbar(id);
                    }, 100);
                } else {
                    clearInterval(interval);
                }
                $(this).css("opacity", "1.0");
                button = 0;
            }
        })
        .mouseup(function(e) {
            ismousedown = false;
            if (e.button == button) {
                clearInterval(interval);
                $(this).css("opacity", "0.8");
                button = 0;
            }
        })
        .on('touchstart', function(e) {
            button = 2;
        })
        .on('touchend', function(e) {
            button = 0;
        });

	setup3dhop();
});
</script>
    {% include footer.html %}
</aside>
</div>
</div>
  </body>

</html>
